<!-- web/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mini Shop</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --accent:#006ee6;
      --muted:#6b7280;
      --gap:12px;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family: Inter, Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .app {
      min-height:100vh;
      box-sizing:border-box;
      padding:18px;
      display:flex;
      flex-direction:column;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    h1 { font-size:18px; margin:0; color:#0f172a; }
    p.subtitle { margin:0; color:var(--muted); font-size:13px; }

    .form {
      display:flex;
      gap:10px;
      margin-bottom:14px;
    }
    .form input[type="text"]{
      flex:1;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid #e6e9ef;
      font-size:15px;
      box-shadow:0 1px 0 rgba(16,24,40,0.02) inset;
    }
    .form button{
      padding:12px 14px;
      border-radius:10px;
      border:none;
      background:var(--accent);
      color:white;
      font-weight:600;
      cursor:pointer;
      min-width:110px;
    }

    /* Сетка плиток */
    .grid {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:var(--gap);
      align-items:start;
    }

    /* карточка товара */
    .card {
      background:var(--card);
      border-radius:12px;
      padding:12px;
      box-shadow: 0 6px 18px rgba(16,24,40,0.06);
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:70px;
      justify-content:center;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .card:hover { transform: translateY(-4px); box-shadow:0 10px 26px rgba(16,24,40,0.09); }
    .card .title { font-size:14px; font-weight:700; color:#0f172a; word-break:break-word; }
    .card .meta { font-size:12px; color:var(--muted); }

    /* адаптив: на мобилке 3 в ряд как просил */
    @media (max-width: 520px) {
      .grid { grid-template-columns: repeat(3, 1fr); gap:8px; }
      .form input[type="text"]{ font-size:14px; padding:10px; }
      .form button{ padding:10px; font-size:14px; min-width:80px; }
    }

    /* более узкие экраны — 2 в ряд */
    @media (min-width:521px) and (max-width:800px){
      .grid { grid-template-columns: repeat(3, 1fr); } /* ты просил 3 в ряд на мобилке, сохраняем 3 */
    }

    /* fallback: очень маленькие — 1 в ряд */
    @media (max-width:360px){
      .grid { grid-template-columns: repeat(2, 1fr); } 
    }

    .empty {
      color:var(--muted);
      text-align:center;
      padding:18px;
      background: linear-gradient(90deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
      border-radius:10px;
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div>
        <h1>Mini Shop</h1>
        <p class="subtitle">Добавь товар — он сразу появится в списке</p>
      </div>
    </header>

    <div class="form" role="form" aria-label="Добавить товар">
      <input id="productName" type="text" placeholder="Название товара" autocomplete="off" />
      <button id="addBtn" type="button">Добавить</button>
    </div>

    <div id="productsArea">
      <div id="products" class="grid"></div>
      <div id="empty" class="empty" style="display:none;margin-top:12px;">Список пуст — добавь первый товар</div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    // делаем fullscreen-поведение
    try { tg.expand(); } catch(e){ console.warn(e); }

    const productInput = document.getElementById('productName');
    const addBtn = document.getElementById('addBtn');
    const productsContainer = document.getElementById('products');
    const emptyEl = document.getElementById('empty');

    // Рендер одной карточки (возвращает DOM)
    function createCard(product){
      const card = document.createElement('div');
      card.className = 'card';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = product.name;
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `ID: ${product.id}`;
      card.appendChild(title);
      card.appendChild(meta);
      return card;
    }

    function renderProducts(products){
      productsContainer.innerHTML = '';
      if(!products || products.length === 0){
        emptyEl.style.display = 'block';
        productsContainer.style.display = 'none';
        return;
      }
      emptyEl.style.display = 'none';
      productsContainer.style.display = 'grid';
      products.forEach(p => {
        productsContainer.appendChild(createCard(p));
      });
    }

    // Кнопка Добавить
    addBtn.addEventListener('click', () => {
      const name = productInput.value.trim();
      if(!name) return;
      // отправляем на бота — бот запишет в БД и пришлёт JSON-ответ (в чат, мы удалим)
      tg.sendData(name);
      productInput.value = '';
      productInput.focus();
    });

    // при нажатии Enter в инпуте — добавляем
    productInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') {
        addBtn.click();
      }
    });

    // При старте — запрашиваем список товаров
    function requestProducts(){
      tg.sendData("__get_products__"); // бот ответит JSON с products
    }

    // Слушаем сообщения от бота (бот отправляет JSON в чат, WebApp получает событие 'message')
    Telegram.WebApp.onEvent('message', (msg) => {
      try {
        const text = msg.text;
        if(!text) return;
        // ожидаем JSON как {"products":[{id:1,name:"..."}, ...]}
        const data = JSON.parse(text);
        if(data && Array.isArray(data.products)){
          renderProducts(data.products);
        }
      } catch (err) {
        console.error('Ошибка парсинга данных от бота:', err, msg);
      }
    });

    // при инициализации
    (function init(){
      // попросим бота прислать текущий список
      requestProducts();
      productInput.focus();
    })();
  </script>
</body>
</html>
